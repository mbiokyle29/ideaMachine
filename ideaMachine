#!/usr/bin/env perl
use Mojolicious::Lite;
use DBI;
my $user = "ideaMac";
my $pass = "deusXmach";

my $dbh = DBI->connect("DBI:mysql:Idea", $user, $pass);

get '/' => sub {
	my $self = shift;
	my $ref = &select_ideas;
	$self->stash(ideas => $ref);
	$self->render('index');
};

post '/idea' => sub {
	my $self = shift;
	my $idea = $self->param('title');
	my $desc = $self-> param('description');
	my $submitter = $self->param('user');
	my $id = insert_idea($idea, $desc, $submitter);
	$self->redirect_to("/idea/$id");
};

get '/idea/:id/' => sub {
	my $self = shift;
	my $id = $self->param('id');
	my $idea = &select_idea($id);
	$self->stash(idea => $idea);
	$self->render('idea');
};

sub insert_idea
{
	my $title = shift;
	my $description = shift;
	my $user = shift;
	my $q = "INSERT INTO ideas (title, description, user) values (?,?,?)";
	my $sth = $dbh->prepare($q);
	$sth->execute($title, $description, $user);
	return $dbh->{'mysql_insertid'};
}

sub select_ideas
{
	my $q = "SELECT title, description, user from ideas LIMIT 10";
	my $sth = $dbh->prepare($q);
	$sth->execute();
	my $arr_ref = $sth->fetchall_arrayref;
	return $arr_ref;
}

sub select_idea
{
	my $id = shift;
	my $q = "SELECT title, description, user from ideas WHERE id=?";
	my $sth = $dbh->prepare($q);
	$sth->execute($id);
	my $arr_ref = $sth->fetchrow_arrayref;
	return $arr_ref;
}
app->start;
